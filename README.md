# Rails Google Sheets API

[![GitHub](https://img.shields.io/github/license/jestrade/Rails-Google-Sheets-API)](https://github.com/jestrade/Rails-Google-Sheets-API)
[![Ruby](https://img.shields.io/badge/Ruby-3.4.7-red)](https://www.ruby-lang.org/)
[![Rails](https://img.shields.io/badge/Rails-8.1.1-red)](https://rubyonrails.org/)

A lightweight Rails API service that integrates with Google Sheets and Gemini AI to manage product inventory. It checks for existing products by SKU and creates new entries with AI-generated confirmation messages, all while providing robust error tracking through Bugsnag.

Built with a clean service-oriented architecture for maintainability and testability.

## Features

- **Rails 8.1 API-only application** (no database required)
- **Service-Oriented Architecture** - Clean separation of concerns with dedicated service objects
- **Google Sheets Integration** - Seamless integration via Service Account
- **Gemini AI Integration** - AI-generated product confirmation messages
- **Real-time product lookup** by SKU
- **Automatic product creation** for new SKUs
- **Comprehensive error tracking** with Bugsnag
- **Full test coverage** with RSpec (33 examples)
- SSL-secured API endpoints

## Prerequisites

- Ruby 3.4.7
- Bundler
- Google Cloud Service Account with Sheets API access
- Gemini API key (for AI-generated confirmations)

## Installation

1. Clone the repository:
   ```bash
   git clone https://github.com/jestrade/Rails-Google-Sheets-API.git
   cd Rails-Google-Sheets-API
   ```

2. Install dependencies:  
   ```bash
   bundle install
   ```

## Configuration

1. Create a `.env` file in the root directory with the following variables:
   ```env
   # Google Sheets Configuration
   GOOGLE_SERVICE_ACCOUNT_JSON=path/to/your/service-account.json
   GOOGLE_SHEET_KEY=your_google_sheet_id
   
   # Gemini AI Configuration
   GEMINI_API_KEY=your_gemini_api_key
   GEMINI_MODEL=gemini-pro
   
   # Bugsnag Configuration
   BUGSNAG_API_KEY=your_bugsnag_api_key
   ```

2. For Google Sheets access:
   - Share your spreadsheet with the service account email (found in your service account JSON)
   - Grant at least Editor permissions

## Running the Application

Start the development server:
```bash
rails server
```

The API will be available at `http://localhost:3000`

## API Endpoint

### Check Product

Checks if a product exists in Google Sheets by SKU. If it doesn't exist, creates it and returns an AI-generated confirmation message.

```http
POST /ai/products/check
Content-Type: application/json

{
  "product": {
    "sku": "ABC-123",
    "name": "Product Name",
    "price": "19.99",
    "metadata": "Additional information"
  }
}
```

#### Example in cURL:

```bash
curl -X POST http://localhost:3000/ai/products/check \
-H "Content-Type: application/json" \
-d '{"product":{"sku":"ABC-123","name":"My product","price":"12.50","metadata":"from api"}}'
```

#### Example Responses

**Product Already Exists (200 OK)**
```json
{
  "message": "Product with SKU ABC-123 already exists."
}
```

**Product Created (200 OK)**
```json
{
  "message": "Okay, got it! 'My product' with SKU ABC-123 and price $12.50 has been successfully added! ðŸŽ‰"
}
```
*Note: The message is AI-generated by Gemini and may vary.*

**Validation Error (400 Bad Request)**
```json
{
  "error": "sku is required"
}
```

**Server Error (500 Internal Server Error)**
```json
{
  "error": "Error message describing the issue"
}
```

## Architecture

The application follows a clean service-oriented architecture:

### Service Objects

1. **GeminiService** (`app/services/gemini_service.rb`)
   - Handles all Gemini AI API interactions
   - Generates AI-powered confirmation messages
   - Manages API key authentication and error handling

2. **Products::ValidatorService** (`app/services/products/validator_service.rb`)
   - Validates product data (SKU presence, format, etc.)
   - Returns structured validation errors

3. **Products::CheckService** (`app/services/products/check_service.rb`)
   - Orchestrates the product check workflow
   - Coordinates validation, duplicate checking, and creation
   - Integrates with GoogleSheetsService and GeminiService

4. **GoogleSheetsService** (`app/services/google_sheets_service.rb`)
   - Manages Google Sheets read/write operations
   - Handles SKU lookups and product insertion

### Controllers

**Ai::ProductsController** - Thin controller that delegates to service objects

## Error Handling

The application includes comprehensive error handling:
- All unhandled exceptions are captured and reported to Bugsnag
- Google Sheets API errors are gracefully handled
- Gemini AI API failures return fallback messages
- Invalid requests receive appropriate status codes and error messages
- Service objects return standardized error responses

## Development Notes

### SSL Configuration
If you encounter SSL certificate verification issues with Bugsnag, the application includes a patch that adjusts the SSL verification settings. This is automatically loaded in the initializers.

### Testing

The application has comprehensive test coverage with RSpec:

**Run all tests:**
```bash
bundle exec rspec
```

**Run with detailed output:**
```bash
bundle exec rspec --format documentation
```

**Test Coverage:**
- 33 examples, 0 failures
- GeminiService (6 examples)
- Products::ValidatorService (9 examples)
- Products::CheckService (11 examples)
- Ai::ProductsController (7 examples)

See `spec/README.md` for detailed testing documentation.

### Deployment
For production deployment:
1. Set appropriate environment variables
2. Consider adding rate limiting
3. Enable proper authentication
4. Monitor performance as Google Sheets has API rate limits

## Troubleshooting

### Common Issues

- **Permission Denied**: Ensure the service account has edit access to the spreadsheet
- **Invalid JSON**: Verify the `GOOGLE_SERVICE_ACCOUNT_JSON` is valid JSON
- **SSL Errors**: The application includes a patch for common SSL verification issues
- **Gemini API Errors**: Verify your `GEMINI_API_KEY` is valid and has proper permissions
- **Missing SKU**: The API requires a `sku` field in the product payload

## License

[MIT License](https://opensource.org/licenses/MIT)
